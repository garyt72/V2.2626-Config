[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customize for your slicer of choice
gcode:
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float                 %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float                 %}
    {% set min_extrude_temp = printer.configfile.config["extruder"]["min_extrude_temp"] | float %}
    {% set hotend_actual_temp = printer.extruder.temperature                                    %}
    {% set bed_actual_temp = printer.heater_bed.temperature                                     %}
    {% set chamber_target_temp = params.CHAMBER | float(0)                                      %}
    {% set hotend_target_temp  = params.HOTEND  | float(0)                                      %}
    {% set bed_target_temp     = params.BED     | float(0)                                      %}
    {% set purge_x = 135                                                                        %}
    {% set purge_y = 357                                                                        %}
    {% set prefix = "PRINT_START"                                                               %}

    LIGHTS_HIGH
    STATUS_HEATING

    ; set hotend to it's current temp to previent if from cooling just to be reheated
    {% if hotend_target_temp > 0 and hotend_actual_temp > 40 %}
    M104 S{hotend_actual_temp}
    {% endif %}

    {% if hotend_target_temp > 0 and hotend_actual_temp > 160 %}
    M106 S{25/100*255}             ; Turn on part cooling fan to prevent oozing
    {% endif %}

    M220 S100                      ; set feed rate to 100%
    M221 S100                      ; set flow rate to 100%

    ; start heating the bed while we take care of a few things
    ; set bed temp but don't wait
    {% if bed_target_temp > 0 %}
    M140 S{bed_target_temp}        ; set bed target temp, but don't wait
    {% endif %}
      
    ; reset things and home all axes
    G90                            ; absolute positioning
    G92 E0                         ; zero the extruder
    DISPLAY PREFIX={prefix} M117="Homing" CONSOLE="M117" M400="True"
    G28                            ; home all axes
    G0 Z10                         ; move head up a little

    ; if the hotend is not going to ooze and we've got a long wait for the bed
    {% if hotend_actual_temp < 150 and bed_target_temp >= 70 and (bed_target_temp > bed_actual_temp + 5) %}
    G1 X{max_x/2} Y{max_y/2} F6000 ; position head at center of bed while bed is heating 
    {% else %}
    G1 X{purge_x} Y{purge_y} F6000 ; position head over purge bucket while bed is heating
    {% endif %}

    ; set bed temp and wait
    {% if bed_target_temp > 0 %}
    DISPLAY PREFIX={prefix}  M117="Heating Bed" CONSOLE="Heating Bed to {bed_target_temp}" M400="True"
    M190 S{bed_target_temp}        ; heat bed and wait
    {% endif %}

    ; Wait for Chamber temperature to get close before performing QGL
    {% if chamber_target_temp > 0 %}
    DISPLAY PREFIX={prefix}  M117="Chamber Wait" CONSOLE="Waiting for Chamber ({chamber_target_temp} - 1)" M400="True"
	TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={chamber_target_temp - 1} # Wait for chamber temp - 5 degrees
    {% endif %}

    ; perform quad gantry level
    DISPLAY PREFIX={prefix}  M117="QGL" CONSOLE="Performing QGL" M400="True"
    QUAD_GANTRY_LEVEL

    ; Wait for final Chamber temperature 
    {% if chamber_target_temp > 0 %}
    DISPLAY PREFIX={prefix}  M117="Chamber Wait" CONSOLE="Wariting for Chamger ({chamber_target_temp})" M400="True"
	TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={chamber_target_temp} # Wait for chamber temp
    {% endif %}

    ; set hotend temp and wait
    {% if hotend_target_temp > 0 %}
    G1 X{purge_x} Y{purge_y}       ; move over right purge bucket
    DISPLAY PREFIX={prefix}  M117="Heating Hotend" CONSOLE="Heating Hotend to {hotend_target_temp}" M400="True"
    M109 S{hotend_target_temp}     ; heat hotend and wait
    SAVE_VARIABLE VARIABLE=hotend_target_temp VALUE='{hotend_target_temp}'
    G92 E0                         ; zero the extruder
      {% if hotend_target_temp >= min_extrude_temp %}
    G0 E-1                         ; retract 1mm
      {% endif %}
    G92 E0                         ; zero the extruder
    {% endif %}  

    ; clean nozzle and calibrate Z
    DISPLAY PREFIX={prefix}  M117="Nozzle Clean" COSOLE="Cleaning Nozzle" M400="TRUE"
    CLEAN_NOZZLE

    DISPLAY PREFIX={prefix}  M117="Calibrate Z" COSOLE="Performing CALIBRATE_Z" M400="TRUE"
    CALIBRATE_Z

    STATUS_PRINTING

    ; purge line
    {% if hotend_target_temp >= min_extrude_temp %}
    DISPLAY PREFIX={prefix}  M117="Purge Line" M400="True"
    G0 X115 Y0 Z5 F15000           ; move to start of purge line
    G0 Z0.3 F6000                  ; move down to start purge line
    G1 X0 Y0 E25  F1500            ; draw purge line
    G1 X0 Y2 Z0.1 F1500            ; wipe
    G92 E0                         ; zero the extruder
    G1 Z1 F6000                    ; move up a little
    {% endif %}

    DISPLAY PREFIX={prefix}  M117="Printing" M400="True" DURATION=10 ; clear the display

[gcode_macro CHAMBER_WAIT]
gcode:
    {% set temp = params.TEMP | float(0)                                      %}
    ; Wait for Chamber temperature to get close before performing QGL
    {% if temp > 0 %}
    DISPLAY M117="CHAMBER WAIT {temp-5}" CONSOLE="M117"
	TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={temp - 5} MAXIMUM={temp + 5}		# Wait for chamber temp +/- 5 degrees

    DISPLAY M117="CHAMBER WAIT {temp}" CONSOLE="M117"
	TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={temp} MAXIMUM={temp + 5}		# Wait for chamber temp +/- 5 degrees
    {% endif %}

    
[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customize for your slicer of choice
gcode:

    {% set move_xy = 5.0 %}
    {% set move_z = 25.0 %}
    {% set move_z_hop = 0.2 %}

    #   Get Boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    #   Get Current location
    {% set curr_x = printer.toolhead.position.x | float %}
    {% set curr_y = printer.toolhead.position.y | float %}
    {% set curr_z = printer.toolhead.position.z | float %}

    # get min extrude temp 
    {% set min_extrude_temp = printer.configfile.config["extruder"]["min_extrude_temp"] | float %}

    #   Check end position to determine safe positions to move
    {% if (curr_x + move_xy) < max_x   %}
    {%   set x_safe = curr_x + move_xy %}
    {% else                            %}
    {%   set x_safe = curr_x - move_xy %}
    {% endif                           %}
    
    {% if (curr_y + move_xy) < max_y   %}
    {%   set y_safe = curr_y + move_xy %}
    {% else                            %}
    {%   set y_safe = curr_y - move_xy %}
    {% endif                           %}
    
    {% if (curr_z + move_z) < max_z    %}
    {%   set z_safe = curr_z + move_z  %}
    {% else                            %}
    {%   set z_safe = max_z            %}
    {% endif                           %}

    {% if (curr_z + move_z_hop) < max_z       %}
    {%   set z_safe_hop = curr_z + move_z_hop %}
    {% else                                   %}
    {%   set z_safe_hop = max_z               %}
    {% endif                                  %}

    M400                                ; wait for buffer to clear
    G90                                 ; absolute positioning
    G92 E0                              ; zero the extruder

    ; retract
    {% if printer.extruder.temperature > min_extrude_temp %}
    G1 E-1.0 F3600                      ; retract filament
    {% endif %}

    G1 Z{z_safe_hop} F6000              ; move nozzle (z hop)
    G0 X{x_safe} Y{y_safe} F18000       ; move nozzle to remove stringing
    G0 Z{z_safe} F6000                  ; move nozzle up
    TURN_OFF_HEATERS
    G0 X{max_x/2} Y{max_y} F6000        ; park nozzle at center rear
    M107                                ; turn off fan
    M220 S100                           ; set feed rate to 100%
    M221 S100                           ; set flow rate to 100%

    STATUS_READY
    RESET_TIMEOUT

[gcode_macro FILAMENT_LOAD]
gcode:
    {% set svv = printer.save_variables.variables                               %}
    {% set saved_hotend_temp = svv.hotend_target_temp | default(220) | float    %}
    {% set load_unload_temp = params.TEMP | default(saved_hotend_temp) | float  %}
    {% set PREFIX = "FILAMENT_LOAD:"                                            %}
    {% set nozzle_target = printer.extruder.target | float                      %}
    {% set nozzle_actual = printer.extruder.temperature | float                 %}
    {% set x_max = printer.configfile.config["stepper_x"]["position_max"]|float %}


    M104 S{load_unload_temp}     ; start heating nozzle now

    ; check if homed
    HOME_IF_NEEDED

    G90                          ; absolute positioning
    G0 X{x_max/2} Y50 Z75 F20000 ; move to center front of the bed
    M400                         ; wait for moves to finish before continuing

    ; heat the nozzle before loading
    {% if (nozzle_target < [load_unload_temp, nozzle_target]|max) %}
    DISPLAY M117="Heating Nozzle" CONSOLE="M117" PREFIX={PREFIX} ; display message
    M109 S{[load_unload_temp, nozzle_target]|max}               ; heat nozzle and wait
    M400                                                         ; wait for moves to finish before continuing
    {% endif %}

    DISPLAY M117="Loading" CONSOLE="Loading Filament" PREFIX={PREFIX} 
    M83                          ; set extruder to relative
    G1 E50 F300                  ; load
    G1 E50 F300                  ; prime + 50mm 
    G1 E50 F300                  ; prime + 50mm 
    G1 E-1 F300                  ; retract to prevent oosing
    M82                          ; set extruder to absolute
    G4 P100                      ; Dwell to foce puase
    M400                         ; wait for moves to finish before updating message

    DISPLAY M117="Load Done" CONSOLE="Loading Filament Complete" PREFIX={PREFIX} DURATION=10

    
[gcode_macro FILAMENT_UNLOAD]
gcode:
    {% set svv = printer.save_variables.variables                               %}
    {% set saved_hotend_temp = svv.hotend_target_temp | default(220)            %}
    {% set load_unload_temp = params.TEMP | default(saved_hotend_temp) | float  %}
    {% set PREFIX = "FILAMENT_UNLOAD:"                                          %}
    {% set nozzle_target = printer.extruder.target | float                      %}
    {% set nozzle_actual = printer.extruder.temperature | float                 %}
    {% set x_max = printer.configfile.config["stepper_x"]["position_max"]|float %}

    M104 S{load_unload_temp}     ; start heating nozzle now

    ; check if homed
    HOME_IF_NEEDED

    G90                          ; absolute positioning
    G0 X{x_max/2} Y50 Z75 F20000  ; move to center front of the bed
    M400                         ; wait for moves to finish before continuing

    ; heat the nozzle before unloading
    {% if (nozzle_target < [load_unload_temp, nozzle_target]|max) %}
    DISPLAY M117="Heating Nozzle" CONSOLE="M117" PREFIX={PREFIX} ; display message
    M109 S{load_unload_temp}     ; heat nozzle and wait
    M400                         ; wait for moves to finish before continuing
    {% endif %}
    
    DISPLAY M117="Unloading" CONSOLE="Unloading Filament" PREFIX={PREFIX} 
    M83                          ; set extruder to relative
    G1 E20 F300                  ; extrude a little to soften tip
    G1 E-40 F6000                ; retract some, but not too much or it will jam
    M400                         ; wait for moves to finish (force pause)
    G4 P5000                     ; wait 5 seconds for filament to cool
    G1 E-80 F1800                ; retract to unload filament completely
    M82                          ; set extruder to absolute
    M400                         ; wait for moves to finish before updating message

    DISPLAY M117="Unload Done" CONSOLE="Unloading Filament Complete" PREFIX={PREFIX} DURATION=10

[gcode_macro M600]
gcode:
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set X = params.X|default(max_x)|float %}
    {% set Y = params.Y|default(0)|float %}
    {% set Z = params.Z|default(10)|float %}
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE
    G91                   ; relative movement
    G1 E-.8 F2700         ; retract a little
    G1 Z{Z}               ; move Z up 
    G90                   ; absolute movement
    G1 X{X} Y{Y} F3000    ; move to park location
    G91                   ; relative movement
    G1 E-50 F1000         ; retract filament 50mm
    G90                   ; absolute movement
    RESTORE_GCODE_STATE NAME=M600_state

[gcode_macro FLOW_TEST]
description: Flow test [FLOW=target_flowrate (5)] [E=extrude_distance (500)] [PRIME=prime_distance (20)] [TEMP=hotend_temp (220)]
gcode:
    {% set PREFIX = "FLOW_TEST:"                                                         %}
    {% set flow_rate = params.FLOW | default(5) | float                                  %}
    {% set extrude = params.E | default(500) | float                                     %}
    {% set nozzle_diameter = params.NOZZLE | default(0.4) | float                        %}
    {% set prime = params.PRIME | default(20) | float                                    %}
    {% set hotend_target_temp = params.TEMP | default(220) | float                       %}
    {% set area = 3.14159 * ((1.75/2) ** 2)                                              %}
    {% set volume = area * extrude                                                       %}
    {% set feed_rate = (extrude/volume)*60*flow_rate                                     %}
    {% set nozzle_temp = printer.extruder.temperature | float                            %}
    {% set nozzle_target = printer.extruder.target | float                               %}
    {% set min_extrude = printer.configfile.config.extruder.min_extrude_temp | float     %}
    {% set x_max = printer.configfile.config["stepper_x"]["position_max"]|float          %}


    {% if hotend_target_temp < min_extrude                                                      %}
    DISPLAY M117="Preheat First" CONSOLE="Extruder ({nozzle_temp|round(1)}) < min_extrude_temp ({min_extrude}).  Preheat HOTEND first" PREFIX={PREFIX} ; display message
    {% elif flow_rate >= 0.5                                                             %}
    DISPLAY M117="Flow Test" CONSOLE="NOZZLE={nozzle_diamter}mm | FLOW={flow_rate}mm^3/s | E={extrude}mm | PRIME={prime}mm | volume={volume}mm^3 | F={feed_rate}" PREFIX={PREFIX} ; display message
  
    SAVE_GCODE_STATE NAME=flow_test_state ; store current gcode state

    ; check if homed
    HOME_IF_NEEDED

    ; set hotend temp 
    {% if hotend_target_temp > 0 %}
    M104 S{hotend_target_temp}     ; start heating hotend 
    {% endif %}  

    G90                            ; absolute movement
    G1 X{x_max/2} Y50 Z50 F15000   ; move to a good postion

    ; set hotend and wait
    {% if hotend_target_temp > 0 %}
    DISPLAY M117="Heating Hotend" M400="True" PREFIX={PREFIX} 
    M109 S{hotend_target_temp}     ; set hotend and wait
    {% endif %}  


    M400                  ; finish moves
    M117 Prime Nozzle
    M83                   ;relative extrusions 
    G1 F300               ;300mm/min speed 
    G1 E{prime}           ;prime with {prime} distance
    M400                  ; finish moves
    M117 Pause
    G1 F3                 ;slow extrude for pause 
    G1 E0.1               ;0.1mm extrusion 
    G1 F{feed_rate}       ;calculated mm/min speed based on desired flow rate (mm^3/s)
    M400                  ; finish moves
    M117 E{(extrude / 5)|int} F{feed_rate|int} 1/5 
    G1 E{extrude / 5}     ;extrude 1/5 of the distance 5 times
    M400                  ; finish moves
    M117 E{(extrude / 5)|int} F{feed_rate|int} 2/5 
    G1 E{extrude / 5}     ;extrude 1/5 of the distance 5 times
    M400                  ; finish moves
    M117 E{(extrude / 5)|int} F{feed_rate|int} 3/5 
    G1 E{extrude / 5}     ;extrude 1/5 of the distance 5 times
    M400                  ; finish moves
    M117 E{(extrude / 5)|int} F{feed_rate|int} 4/5 
    G1 E{extrude / 5}     ;extrude 1/5 of the distance 5 times
    M400                  ; finish moves
    M117 E{(extrude / 5)|int} F{feed_rate|int} 5/5 
    G1 E{extrude / 5}     ;extrude 1/5 of the distance 5 times
    M400                  ; finish moves
    M117 Done
    RESTORE_GCODE_STATE NAME=flow_test_state ; restore things back to the way they were

    DISPLAY M117="Done" CONSOLE="M117" PREFIX={PREFIX} DURATION=10
    {% elif flow_rate < 1 %}
      RESPOND PREFIX={PREFIX} MSG="FLOW must be >= 1.0 mm^3/s"
    {% endif %}

[gcode_macro DISPLAY]
gcode:
    ; get parameters
    {% set prefix = params.PREFIX | default("INFO") | upper  %}
    {% set m117   = params.M117                              %}
    {% set console = params.CONSOLE                          %}
    {% set duration = params.DURATION | default(0) | float   %}
    {% set m400 = params.M400 | lower                        %}
    {% set debug = params.DEBUG                              %}

    ; determine DEBUG
    {% if debug == "true" or debug == "yes" or debug == "t" or debug == "y" %}
    {%   set debug = true                                                   %}
    {% else                                                                 %}
    {%   set debug = false                                                  %}
    {% endif                                                                %}

    ; determine M400 action or not
    {% if m400 == "true" or m400 == "yes" or m400 == "t" or m400 == "y" %}
    {%   set m400 = true                                                %}
    {% else                                                             %}
    {%   set m400 = false                                               %}
    {% endif                                                            %}

    ; should console = M117 message?
    {% if console | upper == "M117"  %}
    {%   set console = m117          %}
    {% endif                         %}

    {% if debug %}
    RESPOND PREFIX="DISPLAY_MACRO" MSG="M117={m117} | CONSOLE={console} | DURATION={duration} | M400={m400}"
    {% endif %}

    ; Wait for moves to finsih before displaying if M400 parameter was yes/true
    {% if m400 %}
    M400
    {% endif   %}

    ; clear display if M117 and CONSOLE are not set
    {% if m117 == "" and console == "" %}
    M117
    {% endif %}

    ; update printer display
    {% if m117 %}
    M117 {m117}
    {% endif   %}

    ; display console message
    {% if console %}
    RESPOND PREFIX="{prefix | replace(':', '')}:" MSG="{console}"
    {% endif %}

    ; delayed gcode to clear message
    {% if duration > 0 %}
    UPDATE_DELAYED_GCODE ID=CLEAR_DISPLAY DURATION={duration}
    {% endif %}

[gcode_macro HOME_IF_NEEDED]
gcode:
    {% if not 'xyz' in printer.toolhead.homed_axes %}
    DISPLAY M117="Homing" DURATION=10
    G28      
    {% endif %}

[gcode_macro FILAMENT_CHANGE]
gcode: 
    M600

[gcode_macro STEPPERS_OFF]
gcode:
    M84

[gcode_macro FANS_OFF]
gcode:
    M107

[gcode_macro RESET_TIMEOUT]
gcode:
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.config["idle_timeout"]["timeout"]}

[gcode_macro PREHEAT_BED_ABS]
gcode:
    SET_IDLE_TIMEOUT TIMEOUT=5400
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=110
    
[gcode_macro PREHEAT_BED_PLA]
gcode:
    SET_IDLE_TIMEOUT TIMEOUT=5400
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=55
    
[gcode_macro T0]
gcode:
    ; do nothing - this is just to prevent an error when
    ; the T0 tool command is sent by Cura

# Convert Marlin linear advance (M900) commands to Klipper (SET_PRESSURE_ADVANCE) commands.
# Used in conjunction with Marlin's linear advance calibration tool: 
# https://marlinfw.org/tools/lin_advance/k-factor.html
[gcode_macro M900]
gcode:
	# Parameters
	{% set pa = params.K|float %}
	SET_PRESSURE_ADVANCE ADVANCE={pa}

[delayed_gcode CLEAR_DISPLAY]
gcode:
    M117

[gcode_macro G32]
gcode:
    BED_MESH_CLEAR
    G28
    QUAD_GANTRY_LEVEL
    G28
    G0 X175 Y175 Z30 F3600

[gcode_macro FRONT_AND_CENTER]
gcode:
  {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
  {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}
  G0 X{max_x/2} Y0 Z{max_z/2} F30000

[gcode_macro SPEED_TEST]
gcode:
  {% set PREFIX = "SPEED_TEST" %}
  {% set stepper_x_current = printer.configfile.config["tmc2209 stepper_x"]["run_current"]|float %}
  {% set stepper_y_current = printer.configfile.config["tmc2209 stepper_y"]["run_current"]|float %}
  {% set feedrate = (params.SPEED | default(100) | float) * 60 %}
  {% set stepper_current = params.STEPPER_CURRENT | default(stepper_x_current) | float  %}
  {% set iterations = params.ITERATIONS | default(5) | int %}

  DISPLAY M117="Speed = {params.SPEED}mm/s" CONSOLE="M117" PREFIX={PREFIX} 
  DISPLAY M117="Stepper Current = {stepper_current}" CONSOLE="M117" PREFIX={PREFIX} 
  DISPLAY M117="Iterations = {iterations}" CONSOLE="M117" PREFIX={PREFIX} 
  DISPLAY M117="stepper_x_current = {stepper_x_current}" CONSOLE="M117" PREFIX={PREFIX} 
  DISPLAY M117="stepper_y_current = {stepper_y_current}" CONSOLE="M117" PREFIX={PREFIX} 

  {% if (stepper_current > stepper_x_current) or (stepper_current > stepper_y_current) %}
  DISPLAY M117="specified current greater than current configuration - aborting"
  {% else %}

  {% if (stepper_x_current != stepper_current) %}
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT={stepper_current} 
  {% endif %}

  {% if (stepper_y_current != stepper_current) %}
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT={stepper_current} 
  {% endif %}


  ; check if homed
  HOME_IF_NEEDED

  G0 X25 Y25 Z25 F6000
  G0 F{feedrate}

  # diagonal 1 
  DISPLAY M117="B (stepper_x) motor only" CONSOLE="M117" PREFIX={PREFIX} 
  {% for count in range(1,iterations) %}
  G0 X325 Y325     ; back right
  G0 X25  Y25      ; front left
  {% endfor %}

  # X only
  DISPLAY M117="X-axis only" CONSOLE="M117" PREFIX={PREFIX} 
  {% for count in range(1,iterations) %}
  G0 X325          ; front right
  G0 X25           ; front left
  {% endfor %}
  G0 X325          ; front right

  # diagonal 2
  DISPLAY M117="A motor (stepper_y) only}" CONSOLE="M117" PREFIX={PREFIX} 
  {% for count in range(1,iterations) %}
  G0 X25  Y325     ; back left
  G0 X325 Y25      ; front right
  {% endfor %}

  # Y only
  DISPLAY M117="Y-axis only" CONSOLE="M117" PREFIX={PREFIX} 
  {% for count in range(1,iterations) %}
  G0 Y325          ; back right
  G0 Y25           ; front right
  {% endfor %}

  ; back to center
  G0 X25 Y25 Z25 F6000

  SET_TMC_CURRENT STEPPER=stepper_x CURRENT={stepper_x_current} 
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT={stepper_y_current}
  {% endif %}


[gcode_macro BED_MESH_CALIBRATE_FULL]
gcode:
    LIGHTS_HIGH
    QUAD_GANTRY_LEVEL
    CALIBRATE_Z
    BED_MESH_CALIBRATE
    LIGHTS_LOW
    LIGHTS_HIGH

[gcode_macro SEARCH_VARS]
gcode:
    {% set search = params.S|lower %}
    {% set ns = namespace() %}
    {% for item in printer  %}
        {% if ' ' in item %}
            {% set ns.path = ['printer', "['%s']" % (item), ''] %}
        {% else %}
            {% set ns.path = ['printer.', item, ''] %}   
        {% endif %} 

        {% if search in ns.path|lower %}
            { action_respond_info(ns.path|join) }
        {% endif %} 

        {% if printer[item].items() %}
            {% for childkey, child in printer[item].items() recursive %}
                {% set ns.path = ns.path[:loop.depth|int + 1] %}

                {% if ' ' in childkey %}
                    {% set null = ns.path.append("['%s']" % (childkey)) %}
                {% else %}
                    {% set null = ns.path.append(".%s" % (childkey)) %}
                {% endif %} 

                {% if child is mapping  %}
                    { loop(child.items()) }
                {% else %}
                    {% if search in ns.path|lower %}
                        { action_respond_info("%s : %s" % (ns.path|join, child)) }   
                    {% endif %} 
                {% endif %} 
                
            {% endfor %}
        {% endif %} 
    {% endfor %}


[delayed_gcode shutdown_machine]
gcode:
    {action_call_remote_method("shutdown_machine")}


[delayed_gcode reboot_machine]
gcode:
    {action_call_remote_method("reboot_machine")}

[gcode_shell_command hello_world]
command: echo hello world
timeout: 2.0
verbose: True

[gcode_shell_command backup_cfg]
command: sh /home/pi/autocommit.sh
timeout: 30.
verbose: True

[gcode_macro BACKUP_CFG]
gcode:
    RUN_SHELL_COMMAND CMD=backup_cfg
